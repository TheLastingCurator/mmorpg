# Сетевой движок

## Требования

Технически игра должна суметь обслуживать столько же одновременно подключенных игроков, сколько было на пике у Eve Online, то есть 65 303.

Нужно сразу готовиться к масштабированию игры путем увеличения количества серверов ее обслуживающих.
Все должно быть устроено таким образом что на каждом сервере можно было обслуживать тысячи игроков.

В мморпг прокачка и урон должны происходить на сервере, а на клиенте должен только показываться интерфейс.

## Важно учитывать

Игровой сервер предполагается разворачивать на Raspberry Pi 4 с 4 гигабайтами RAM и безлимитным 1 гигабитным сетевым подключением.

В тестах Raspberry Pi 4 развивает скорость до 930Mbs, это 116,250,000 байт в секунду.

На каждого из 65 303 клиентов это 1780 байт в секунду. При пакет-лоссе 10% полезных данных остается 1602 байт/с.

Размеры заголовков: Ethernet - 14 байт, IP - 20 байт, TCP - 20 байт. Итого: 54 байта.

Клиенту необходимо отправлять хотя бы 5 обновлений мира в секунду, на обновление выходит 320 байт, из которых 266 полезной нагрузки.

При попытке отправлять клиенту 20 обновлений в секунду на обновление выйдет 80 байт, из которых 26 полезной нагрузки.

В 26 байт вполне можно уместить информацию о 2 персонажах из поля зрения в простом формате типа:

id персонажа = 2 байта, позиция = 4 байта, код действия = 2 байта, позиция действия = 4 байта, это позволит при 60 APM показывать все действия 40 персонажей в поле зрения.

## Представление состояния мира

Для хранения и передачи по сети состояний всего что может менять состояние в игре используется специальная структура данных:

Есть большой массив со всеми персонажами и активными монстрами, размер его заранее выбирается достаточно большим, чтобы не требовалось реаллокаций. В каждой ячейке кроме позиции и параметров персонажа хранится уникальный идентификатор персонажа, получаемый путем инкремента 64-битного счетчика при каждом создании нового персонажа. На персонажей таким образом можно хранить указатели, которые всегда указывают на валидную память в которой лежит либо тот самый персонаж на которого указатель указывал изначально, либо какой-то другой, который поместили в ту же ячейку после смерти старого. 

Для валидации указателей вместе с ними нужно хранить значение уникального идентификатора, если оно совпадает, персонаж точно тот самый, а если не совпадает - указатель протух. Для передачи по сети для каждого клиента заводится исходящий буфер, очередь отправки и массив битиков обозначающих присутствие в очереди соответствующего персонажа. Очередь организуется как циклический буфер достаточного размера чтобы туда уместились указатели на всех персонажей.

При изменении состояния персонажа, для каждого клиента проделываются следующие действия: в массиве битиков выставляется (если еще не была выставлена) единичка для этого персонажа. Если до этого там был нолик, то указатель на этого персонажа добавляется в очередь на отправку. Раз в кадр, если в буфере клиента есть свободное место, буфер заполняется данными о состоянии персонажей в порядке появления в очереди на отправку, и содержимое буфера отправляется по сети клиенту.

Таким образом при быстром изменении состояния одного персонажа, клиент с медленной сетью получает не последовательность состояний, а только одно свежее состояние.

В ходе работы не происходит ни одной аллокации или деаллокации, память не фрагментируется, обход памяти происходит в основном последовательно. Дальнейшие оптимизации: не ставить в очередь на отправку далекие и невидимые клиенту персонажи, не передавать мгновенные координаты, а использовать координаты начала и конца и моментах начала и конца движения, так что состояние начавшего двигаться из точки А в точку Б персонажа достаточно передать 1 раз, после чего персонаж на сервере и у всех клиентов будет двигаться синхронно до точки Б, где он и остановится.

Часто кликающих туда-сюда игроков и ИИ можно затроттлить, чтобы персонажи не меняли текущее действие чаще чем 4 раза в секунду.

## Лаг-компенсация на клиенте

Игрок кликает мышкой. Клиент игрока рисует визуальный отклик, чтобы игрок понимал, что его клик воспринят игрой. На сервер отправляется команда «иди туда». Сервер получает команду, например через 25 мс, и  применяет ее к персонажу игрока. В плане действий персонажа появляется новое состояние «персонаж в следующий кадр физики начнёт движение из той точки где он будет в следующий кадр физики в ту точку которую указал игрок». Следующий физический кадр отстоит от этого момента на 50 мс в будущее, то есть физика квантована по 20 кадров в секунду и считается вперёд на 1 кадр в будущее. Теперь у сервера есть данные о действиях игрока на 50 мс вперёд, сервер записывает последнее действие в состояние персонажа и оно синхронизируется по сети. Все игроки с хорошей сетью получают это состояние. У них 50 мс на то, чтобы успеть получить данные и нарисовать идеальную картинку. Клиент не обязан выкидывать предыдущие состояния персонажа, полученные по сети, клиенту не нужно быть высокоэффективным, поэтому клиент может хранить 2 последних состояния и использовать их для показа идеального мультика о движении персонажа.

Если же у клиента большой пинг, состояние дойдёт к нему поздно, скажем на 150 мс позже чем хотелось бы, за это время персонаж на клиенте может оказаться далеко от исходной точки движения описанной новым состоянием и ещё дальше от той точки в которой он должен быть к этому моменту при движении по заданной траектории. Тут начинает применяться клиентская компенсация лага. Персонаж начинает движение из той точки где он визуально находится и движется в ту точку где он должен был бы оказаться, но делает это быстрее чем должен по физике, чтобы за время порядка 250 мс оказаться в идеальной позиции и продолжить движение показывая идеальную картинку.


## Основные технические характеристики 

Игровой мир будет бесшовным, размер карты 8 км х 8 км, в мире будет всего 262144 персонажей, из которых половина может управляться игроками, а вторая половина - ИИ.

Мир разделяется на шарды по географическому принципу, при этом динамически меняя границы раздела для того, чтобы особо крупные скопления игроков не перегружали отдельные локации.

